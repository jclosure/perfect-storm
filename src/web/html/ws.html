<html>
<head>
    <title>Web Socket Test</title>
    <link href="bootstrap.min.css" rel="stylesheet"/>
    <link href="app.css" rel="stylesheet"/>
    <link href="ui-lightness/jquery-ui-1.10.2.custom.min.css" rel="stylesheet"/>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.10.2.custom.min.js"></script>
    <script type="text/javascript" src="smoothie.js"></script>
    <script type="text/javascript" src="jquery.fiji.ticker.js"></script>
    <script type="text/javascript">
        // Google Graph API
        google.load('visualization', '1', {packages: ['geochart']});
        //    google.setOnLoadCallback(drawVisualization);
        function topNumberOfTweetsPerCountry(data) {
            var array = [
                ['Country', 'Number of tweets']
            ];

            if (data !== undefined) {
                var dataArray = $.makeArray(data);
                var countriesAndTweets = $.map(dataArray, function (val, index) {
                    var countryName = val.countryName;
                    var tweetCount = val.tweetCount;
                    // TODO Ugly, fix!!
                    array.push([countryName, tweetCount]);
                    return null;
                });
            }

            var dataTable = google.visualization.arrayToDataTable(array);
            var geochart = new google.visualization.GeoChart(document.getElementById('tweets-per-country'));
            geochart.draw(dataTable, {width: 556, height: 347});
        }
    </script>
    <script type="text/javascript">
        $(function () {
            //Smoothie
            var smoothie = new SmoothieChart();
            smoothie.streamTo(document.getElementById("tps-canvas"), 1000);
            var tpsLine = new TimeSeries();
            smoothie.addTimeSeries(tpsLine, { strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3 });

            topNumberOfTweetsPerCountry();
            var tweets = [];

            // Socket
            var socket;
            if (window.WebSocket) {
                socket = new WebSocket("ws://localhost:8080/subscribe");
                socket.onmessage = function (event) {
                    var data = event.data;
                    var json = $.parseJSON(data);
                    if (json.eventName === 'tps') {
                        var tps = json.data.tps;
                        tpsLine.append(new Date().getTime(), tps);
                        $("#current-tps").text(tps);
                    } else if (json.eventName === 'country-frequency') {
                        topNumberOfTweetsPerCountry(json.data)
                    } else if (json.eventName === 'matching-tweets') {
                        tweets.push(json.data);
                    } else {
                        console.write(json.eventName);
                    }
//                $('#row').before('<p id="row">' + json.tps + '</p>');
                };
                socket.onopen = function (event) {
                };
                socket.onclose = function (event) {
                };
            } else {
                alert("Your browser does not support Websockets. (Use Chrome)");
            }

            var send = function (message) {
                if (!window.WebSocket) {
                    return;
                }
                if (socket.readyState == WebSocket.OPEN) {
                    socket.send(message);
                } else {
                    alert("The socket is not open.");
                }
            };

            // Twitter feed
            var i = 0;
            $("#matching-tweets").ticker({
                initialTimeout: 100,
                mouseOnTimeout: 400,
                mouseOffTimeout: 300,
                scrollTime: 120,
                fadeTime: 100,
                fixContainer: true,
                next: function (lastItem, nextItem) {
                    var tweet = tweets.pop();
                    if (tweet === undefined) {
                        return "<li></li>";
                    }

                    return '<li>' +
                            '<div class="row-fluid">' +
                            '<div class="span1"><img src="http://www.gravatar.com/avatar/7483?s=48&d=identicon" class="float-left"/></div>' +
                            '<div class="span11"><h2>' + tweet.author + '</h2></div>' +
                            '</div>' +
                            '<div class="row-fluid">' +
                            '<div class="span12">' +
                            '<p>' + tweet.tweet + '</div></div></p></li>'
                }
            });

            // Page
            $("#send-button").click(function () {
                var text = $("#text").val();
                send(text);
            });

        });
    </script>
</head>
<body>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span6">
            <div class="row-fluid">
                <div class="span12">
                    <div style="float: left">Tweets per second:&nbsp;</div>
                    <div id="current-tps"></div>
                    <canvas id="tps-canvas" width="800" height="200"></canvas>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div class="row-fluid">
                        <div class="span12">Number of tweets per country:</div>
                    </div>
                    <div class="row-fluid">
                        <div id="tweets-per-country"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="span6">
            <div class="row-fluid">
                <div class="span12">
                    <form class="form-search" onsubmit="return false;">
                        <input type="text" name="message" value="Hello, World!" x-webkit-speech id="text" style="height: 30px;"
                               class="input-xlarge search-query"/>
                        <input type="button" value="Send Web Socket Data" id="send-button" class="btn"/>
                    </form>
                    <p id="row"/>
                </div>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <ul id="matching-tweets">
                        <li>
                            <img src="http://www.gravatar.com/avatar/7483?s=48&d=identicon"/>

                            <h2>Accus nossimo </h2>

                            <p>blandae des esti to es etur, occum quaerumquos am, nonsequos
                                quis illest eos ma core nus, comnis eatiissit
                                ex</p>

                            <p class="ago">3 hours ago</p>
                        </li>
                        <li>
                            <img src="http://www.gravatar.com/avatar/7183?s=48&d=identicon"/>

                            <h2>sendit undam est et</h2>

                            <p>moluptae Ovit aliqui qui blantio ea voluteste sam ipsam voluptatia
                                vel inus mos cum si quo doluptate et omnienis que

                            <p class="ago">4 hours ago</p>
                        </li>
                        <li>
                            <img src="http://www.gravatar.com/avatar/7283?s=48&d=identicon"/>

                            <h2>sam laborrorum</h2>

                            <p>laciasima net aut eossit acerum ea que nulpa dolut officilignim
                                eosapiduntem dolori coraepr aerchiliquis erum ad et

                            <p class="ago">5 hours ago</p>
                        </li>
                        <li>
                            <img src="http://www.gravatar.com/avatar/7383?s=48&d=identicon"/>

                            <h2>temperunto optatem</h2>

                            <p>laborep rerunt fugit, is mi, volor sit et hiliatiunt, tem aut
                                laut unt ati cum ra velia aut officti adis exerumentur

                            <p class="ago">5 hours ago</p>
                        </li>
                        <li>
                            <img src="http://www.gravatar.com/avatar/7683?s=48&d=identicon"/>

                            <h2>cupiet lacerer umquia</h2>

                            <p>expella quo tem quia sequasi moluptam laboribus nulpa qui dite
                                consed molupta tecesequae moloresti autem et faccum</p>

                            <p class="ago">7 hours ago</p>
                        </li>
                        <li>
                            <img src="http://www.gravatar.com/avatar/7783?s=48&d=identicon"/>

                            <h2>qui con es dit </h2>

                            <p>faccab idem et eium accusam ut et laces nos eatendae ni nis
                                eos apersperoria con porposa in repudae post, simus</p>

                            <p class="ago">8 hours ago</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>