<html>
<head><title>Web Socket Test</title></head>
<body>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="smoothie.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/javascript">
    // Google Graph API
    google.load('visualization', '1', {packages: ['geochart']});
    //    google.setOnLoadCallback(drawVisualization);
    function topNumberOfTweetsPerCountry(data) {
        var array2 = [
            ['Country', 'Number of tweets']
        ];

        var array = [
            ['Country', 'Number of tweets'],
            ['Germany', 200],
            ['United States', 300],
            ['Brazil', 400],
            ['Canada', 500],
            ['France', 600],
            ['RU', 700]
        ];
        if (data !== undefined) {
            var dataArray = $.makeArray(data);
            var countriesAndTweets = $.map(dataArray, function (val, index) {
                var countryName = val.countryName;
                var tweetCount = val.tweetCount;
                return [countryName, tweetCount]
            });

            for (var pair in countriesAndTweets) {
                array2.push([pair.countryName, pair.tweetCount]);
            }
        }

        var dataTable = google.visualization.arrayToDataTable(array2);
        var geochart = new google.visualization.GeoChart(document.getElementById('tweets-per-country'));
        geochart.draw(dataTable, {width: 556, height: 347});
    }
</script>
<script type="text/javascript">
    $(function () {
        //Smoothie
        var smoothie = new SmoothieChart();
        smoothie.streamTo(document.getElementById("tps-canvas"), 1000);
        var tpsLine = new TimeSeries();
        smoothie.addTimeSeries(tpsLine, { strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3 });

        topNumberOfTweetsPerCountry();

        // Socket
        var socket;
        if (window.WebSocket) {
            socket = new WebSocket("ws://localhost:8080/subscribe");
            socket.onmessage = function (event) {
                var data = event.data;
                var json = $.parseJSON(data);
                if (json.eventName === 'tps') {
                    var tps = json.data.tps;
                    tpsLine.append(new Date().getTime(), tps);
                    $("#current-tps").text(tps);
                } else if (json.eventName === 'country-frequency') {
                    topNumberOfTweetsPerCountry(json.data)
                } else {
                    console.write(json.eventName);
                }
//                $('#row').before('<p id="row">' + json.tps + '</p>');
            };
            socket.onopen = function (event) {
            };
            socket.onclose = function (event) {
            };
        } else {
            alert("Your browser does not support Websockets. (Use Chrome)");
        }

        var send = function (message) {
            if (!window.WebSocket) {
                return;
            }
            if (socket.readyState == WebSocket.OPEN) {
                socket.send(message);
            } else {
                alert("The socket is not open.");
            }
        };


        // Page
        $("#send-button").click(function () {
            var text = $("#text").val();
            send(text);
        });

    });
</script>

<div style="float: left">Tweets per second:&nbsp;</div>
<div id="current-tps"></div>
<canvas id="tps-canvas" width="800" height="200"></canvas>
<br/>

<div id="tweets-per-country"></div>

<form onsubmit="return false;">
    <input type="text" name="message" value="Hello, World!" x-webkit-speech id="text"/>
    <input type="button" value="Send Web Socket Data" id="send-button"/>
</form>
<p id="row"/>
</body>
</html>